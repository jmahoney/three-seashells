<html>
<head>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/annyang/2.0.0/annyang.min.js"></script>
  <script src='https://code.responsivevoice.org/responsivevoice.js'></script>
  <script>
  moralityLevel = 0;
  bullshitLevel = 0;

  function updateMoralityLevelUI() {
    console.log("updating morality level ui");
    console.log("b: " + bullshitLevel + " m: " + moralityLevel);
    var levelText = "";
    var levelColor = "";
    switch (moralityLevel) {
      case 0:
        levelText = "acceptable";
        levelColor = "";
        break;
      case 2:
        levelText = "at risk";
        levelColor = "yellow";
        break;
      case 3:
        levelText = "unacceptable";
        levelColor = "orange";
      default:
        levelText = "intolerable";
        levelColor = "red";
        break;
    }

    var x = document.getElementById('morality-level');
    x.style.color = levelColor;
    x.style.innerHTML = levelText;
  }

  var Internet = {
    get: function(url, callback, err) {
            err = err || function(_) {}
            var request = new XMLHttpRequest();
          	request.open("GET", url, true);
          	request.onreadystatechange = function () {
	          if (4 == request.readyState) {
                    if (200 == request.status) {
    		    callback(request.responseText);
                    } else { err(request); }
    	    }
    	};
    	request.send();
        }
    };

  function getPuppy(){
    q = "puppy";

    request = new XMLHttpRequest;
    request.open('GET', 'http://api.giphy.com/v1/gifs/random?api_key=dc6zaTOxFJmzC&tag='+q, true);

    request.onload = function() {
      if (request.status >= 200 && request.status < 400){
        data = JSON.parse(request.responseText).data.image_url;
        console.log(data);
        document.getElementById("puppy").innerHTML += '<center><img src = "'+data+'"  title="GIF via Giphy"></center>';
      } else {
        console.log('reached giphy, but API returned an error');
       }
    };

    request.onerror = function() {
      console.log('connection error');
    };

    request.send();
  }

  if (annyang) {
    annyang.debug();
    annyang.addCallback('error', function () {
      console.log('error');
    });
    annyang.addCallback('errorNetwork', function () {
      console.log('errorNetwork');
    });
    annyang.addCallback('errorPermissionDenied', function () {
      console.log('errorPermissionDenied');
    });
    annyang.addCallback('errorPermissionBlocked', function () {
      console.log('errorPermissionBlocked');
    });
    var commands = {
      '*term': function(term) {
          Internet.get("/level?term=" + term, function(response){
            //responsiveVoice.speak(response);
            if (response.moralityLevel == 0) {
              if (moralityLevel < 0) {
                moralityLevel = moralityLevel -= 1;
              }
            } else {
              moralityLevel = moralityLevel += response.moralityLevel;
            }
            updateMoralityLevelUI();
          });
        }
      };

    annyang.addCommands(commands);
    annyang.setLanguage("en-NZ");
    annyang.start({ autoRestart: true, continuous: false });
  }
  </script>
</head>
<body>
  <div class="container">
    <div id="morality" class="half">
      <p>Morality level: <span id="morality-level">Acceptable</span></p>
    </div>
    <div id="nonsense" class="half">
      <p>Nonsense level: <span id="nonsense-level">Stable</span></p>
    </div>
    <div id="latest-fine" class="full" style="display:none;">
      <p id="offending-text">"f*****g Team City is s**t"</p>
      <p id="fine-level">is unnaceptably immoral</p>
      <p>You have been fined $<span id="fine-amount">2</span> for breach of the Verbal Morality Statute.</p>
    </div>
  </div>
</body>
</html>
